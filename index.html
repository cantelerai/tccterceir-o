<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Igreja Assembleia - Gralha Azul</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* === (mantenha todo o seu CSS atual aqui) === */
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color:#f5f7fa; color:#333; line-height:1.6; }
        /* ... (todo o restante do seu CSS) ... */
    </style>
</head>
<body>
    <!-- Mantenha todo o seu HTML atual -->

    <script>
        /***********************
         * Configuração do Supabase
         ***********************/
        const SUPABASE_URL = 'https://xskasvseypvxuulkevil.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhza2FzdnNleXB2eHV1bGtldmlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTEyODgsImV4cCI6MjA3Mzg2NzI4OH0.QMJOGkErNQPhW0ZnRKc6fC5f7Wxze68GnW7hf9lmMXo';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /***********************
         * Dados padrão (fallback)
         ***********************/
        const defaultData = {
            heroTitle: "Igreja Assembleia de Deus - Gralha Azul",
            address: "Rua Nossa Senhora do Perpétuo Socorro, 322 - Bairro Costeira - Araucária",
            phone: "(41) 999601251",
            email: "igrejaassembleiaaraucaria@gmail.com",
            pix: "116.796.689-94",
            aboutTitle: "Nossa História",
            aboutSubtitle: "Conheça um pouco sobre nossa igreja e nossa missão",
            aboutText1: "A Igreja Assembleia de Deus em Araucária tem como missão servir a comunidade local, pregando o Evangelho de Jesus Cristo e promovendo o crescimento espiritual de seus membros.",
            aboutText2: "Nossa congregação está localizada no Bairro Costeira e temos orgulho de fazer parte desta comunidade há vários anos.",
            aboutText3: "Estamos comprometidos com os valores cristãos e com o bem-estar espiritual de todos que buscam a Deus.",
            ministriesTitle: "Nossos Ministérios",
            ministriesSubtitle: "Conheça as diferentes formas de se conectar e servir em nossa comunidade",
            eventsTitle: "Próximos Eventos",
            eventsSubtitle: "Participe de nossas celebrações e atividades",
            sermonsTitle: "Pregações Recentes",
            sermonsSubtitle: "Assista ou ouça nossas mensagens mais recentes",
            contactTitle: "Entre em Contato",
            contactSubtitle: "Estamos à disposição para responder suas perguntas",
            donationTitle: "Faça uma Doação",
            donationSubtitle: "Suporte nossa missão e ajude a manter nosso trabalho",
            donationText: "Sua doação é fundamental para mantermos nossas atividades e projetos sociais. Com seu apoio, podemos continuar espalhando a palavra de Deus e ajudando nossa comunidade.",
            pixDescription: "Faça uma doação rápida e segura via PIX",
            presentialDonationText: "Você também pode fazer sua doação pessoalmente em nossa igreja",
            serviceTimes: `Segunda: 20h00 (Oração)
Terça-feira: 20h00 (Culto de ensino Sede)
Quarta-feira: 19h00 (Ensaio irmãs)
Quinta-feira: 19h00 (Ensaio irmãos)
Sexta-feira: 20h00 (Culto de ensino)
Domingo: 09h00 (EBD)
Domingo: 19h00 (Culto)`,
            ministries: [],
            events: [],
            sermons: [],
            emails: []
        };

        /***********************
         * Funções do Supabase
         ***********************/
        async function loadData() {
            try {
                console.log('Carregando dados do Supabase...');
                const [configData, ministriesData, eventsData, sermonsData, emailsData] = await Promise.all([
                    fetchConfig(),
                    fetchMinistries(),
                    fetchEvents(),
                    fetchSermons(),
                    fetchEmails()
                ]);

                const combinedData = {
                    ...configData,
                    ministries: ministriesData,
                    events: eventsData,
                    sermons: sermonsData,
                    emails: emailsData
                };

                console.log('Dados carregados com sucesso:', combinedData);
                return combinedData;
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                return defaultData;
            }
        }

        async function fetchConfig() {
            try {
                const { data, error } = await supabase
                    .from('site_config')
                    .select('key, value');

                if (error) {
                    console.error('Erro ao buscar configurações:', error);
                    return {};
                }

                const config = {};
                if (data) {
                    data.forEach(item => {
                        config[item.key] = item.value;
                    });
                }
                return config;
            } catch (error) {
                console.error('Erro em fetchConfig:', error);
                return {};
            }
        }

        async function fetchMinistries() {
            try {
                const { data, error } = await supabase
                    .from('ministries')
                    .select('*')
                    .order('id');

                if (error) {
                    console.error('Erro ao buscar ministérios:', error);
                    return [];
                }

                return data || [];
            } catch (error) {
                console.error('Erro em fetchMinistries:', error);
                return [];
            }
        }

        async function fetchEvents() {
            try {
                const { data, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('id');

                if (error) {
                    console.error('Erro ao buscar eventos:', error);
                    return [];
                }

                return data || [];
            } catch (error) {
                console.error('Erro em fetchEvents:', error);
                return [];
            }
        }

        async function fetchSermons() {
            try {
                const { data, error } = await supabase
                    .from('sermons')
                    .select('*')
                    .order('id');

                if (error) {
                    console.error('Erro ao buscar pregações:', error);
                    return [];
                }

                return data || [];
            } catch (error) {
                console.error('Erro em fetchSermons:', error);
                return [];
            }
        }

        async function fetchEmails() {
            // Só busca emails se estiver autenticado como admin
            if (!isAdmin()) {
                return [];
            }

            try {
                const { data, error } = await supabase
                    .from('emails')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Erro ao buscar emails:', error);
                    return [];
                }

                return data || [];
            } catch (error) {
                console.error('Erro em fetchEmails:', error);
                return [];
            }
        }

        async function saveConfig(key, value) {
            try {
                const { error } = await supabase
                    .from('site_config')
                    .upsert({ 
                        key: key, 
                        value: value, 
                        updated_at: new Date().toISOString() 
                    }, {
                        onConflict: 'key'
                    });

                if (error) {
                    console.error('Erro ao salvar configuração:', error);
                    throw error;
                }
                console.log(`Configuração "${key}" salva com sucesso`);
            } catch (error) {
                console.error('Erro em saveConfig:', error);
                throw error;
            }
        }

        async function saveMinistry(ministry) {
            try {
                if (ministry.id) {
                    const { error } = await supabase
                        .from('ministries')
                        .update(ministry)
                        .eq('id', ministry.id);
                    
                    if (error) throw error;
                    console.log('Ministério atualizado:', ministry.id);
                } else {
                    const { data, error } = await supabase
                        .from('ministries')
                        .insert([ministry])
                        .select();
                    
                    if (error) throw error;
                    console.log('Ministério criado:', data[0].id);
                }
            } catch (error) {
                console.error('Erro em saveMinistry:', error);
                throw error;
            }
        }

        async function deleteMinistry(id) {
            try {
                const { error } = await supabase
                    .from('ministries')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                console.log('Ministério deletado:', id);
            } catch (error) {
                console.error('Erro em deleteMinistry:', error);
                throw error;
            }
        }

        async function saveEvent(event) {
            try {
                if (event.id) {
                    const { error } = await supabase
                        .from('events')
                        .update(event)
                        .eq('id', event.id);
                    
                    if (error) throw error;
                    console.log('Evento atualizado:', event.id);
                } else {
                    const { data, error } = await supabase
                        .from('events')
                        .insert([event])
                        .select();
                    
                    if (error) throw error;
                    console.log('Evento criado:', data[0].id);
                }
            } catch (error) {
                console.error('Erro em saveEvent:', error);
                throw error;
            }
        }

        async function deleteEvent(id) {
            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                console.log('Evento deletado:', id);
            } catch (error) {
                console.error('Erro em deleteEvent:', error);
                throw error;
            }
        }

        async function saveSermon(sermon) {
            try {
                if (sermon.id) {
                    const { error } = await supabase
                        .from('sermons')
                        .update(sermon)
                        .eq('id', sermon.id);
                    
                    if (error) throw error;
                    console.log('Pregação atualizada:', sermon.id);
                } else {
                    const { data, error } = await supabase
                        .from('sermons')
                        .insert([sermon])
                        .select();
                    
                    if (error) throw error;
                    console.log('Pregação criada:', data[0].id);
                }
            } catch (error) {
                console.error('Erro em saveSermon:', error);
                throw error;
            }
        }

        async function deleteSermon(id) {
            try {
                const { error } = await supabase
                    .from('sermons')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                console.log('Pregação deletada:', id);
            } catch (error) {
                console.error('Erro em deleteSermon:', error);
                throw error;
            }
        }

        async function saveEmail(emailData) {
            try {
                const { data, error } = await supabase
                    .from('emails')
                    .insert([emailData])
                    .select();

                if (error) throw error;
                console.log('Email salvo:', data[0].id);
                return data[0];
            } catch (error) {
                console.error('Erro em saveEmail:', error);
                throw error;
            }
        }

        async function deleteEmail(id) {
            try {
                const { error } = await supabase
                    .from('emails')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                console.log('Email deletado:', id);
            } catch (error) {
                console.error('Erro em deleteEmail:', error);
                throw error;
            }
        }

        /***********************
         * Utilitários
         ***********************/
        function isAdmin() {
            return localStorage.getItem('isAdmin_v1') === "true";
        }

        function setAdmin(flag) {
            localStorage.setItem('isAdmin_v1', flag ? "true" : "false");
        }

        function uid() {
            return Math.floor(Math.random() * 1000000);
        }

        /***********************
         * Renderizadores
         ***********************/
        function renderAll() {
            loadData().then(data => {
                console.log('Renderizando dados...', data);
                
                // Renderizar conteúdo textual
                document.getElementById('heroTitle').textContent = data.heroTitle || defaultData.heroTitle;
                document.getElementById('addressText').textContent = data.address || defaultData.address;
                document.getElementById('aboutTitle').textContent = data.aboutTitle || defaultData.aboutTitle;
                document.getElementById('aboutSubtitle').textContent = data.aboutSubtitle || defaultData.aboutSubtitle;
                document.getElementById('aboutText1').textContent = data.aboutText1 || defaultData.aboutText1;
                document.getElementById('aboutText2').textContent = data.aboutText2 || defaultData.aboutText2;
                document.getElementById('aboutText3').textContent = data.aboutText3 || defaultData.aboutText3;
                document.getElementById('ministriesTitle').textContent = data.ministriesTitle || defaultData.ministriesTitle;
                document.getElementById('ministriesSubtitle').textContent = data.ministriesSubtitle || defaultData.ministriesSubtitle;
                document.getElementById('eventsTitle').textContent = data.eventsTitle || defaultData.eventsTitle;
                document.getElementById('eventsSubtitle').textContent = data.eventsSubtitle || defaultData.eventsSubtitle;
                document.getElementById('sermonsTitle').textContent = data.sermonsTitle || defaultData.sermonsTitle;
                document.getElementById('sermonsSubtitle').textContent = data.sermonsSubtitle || defaultData.sermonsSubtitle;
                document.getElementById('contactTitle').textContent = data.contactTitle || defaultData.contactTitle;
                document.getElementById('contactSubtitle').textContent = data.contactSubtitle || defaultData.contactSubtitle;
                document.getElementById('donationTitle').textContent = data.donationTitle || defaultData.donationTitle;
                document.getElementById('donationSubtitle').textContent = data.donationSubtitle || defaultData.donationSubtitle;
                document.getElementById('donationText').textContent = data.donationText || defaultData.donationText;
                document.getElementById('pixDescription').textContent = data.pixDescription || defaultData.pixDescription;
                document.getElementById('presentialDonationText').textContent = data.presentialDonationText || defaultData.presentialDonationText;
                document.getElementById('pixKey').textContent = data.pix || defaultData.pix;
                
                // Renderizar elementos dinâmicos
                renderMinistries(data.ministries);
                renderEvents(data.events);
                renderSermons(data.sermons);
                renderContact(data);
            }).catch(error => {
                console.error('Erro ao renderizar:', error);
                // Usar dados padrão em caso de erro
                renderMinistries(defaultData.ministries);
                renderEvents(defaultData.events);
                renderSermons(defaultData.sermons);
                renderContact(defaultData);
            });
        }

        function renderMinistries(ministries) {
            const grid = document.getElementById('ministriesGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            ministries.forEach(min => {
                const card = document.createElement('div');
                card.className = 'feature-card';
                card.innerHTML = `
                    <div class="feature-icon"><i class="${min.icon}"></i></div>
                    <div class="feature-content">
                        <h3>${min.name}</h3>
                        <p>${min.description}</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderEvents(events) {
            const grid = document.getElementById('eventsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            events.forEach(ev => {
                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="event-date">
                        <h3>${ev.day}</h3>
                        <span>${ev.month}</span>
                    </div>
                    <div class="event-content">
                        <h3>${ev.title}</h3>
                        <p><i class="far fa-clock"></i> ${ev.time || ''}</p>
                        <p><i class="fas fa-map-marker-alt"></i> ${ev.location || ''}</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderSermons(sermons) {
            const list = document.getElementById('sermonList');
            if (!list) return;
            
            list.innerHTML = '';
            sermons.forEach(s => {
                const card = document.createElement('div');
                card.className = 'sermon-card';
                card.innerHTML = `
                    <img src="${s.img_url}" alt="${s.title}" class="sermon-img">
                    <div class="sermon-content">
                        <h3>${s.title}</h3>
                        <p><strong>${s.pastor}</strong> | ${s.date}</p>
                        <p>${s.description}</p>
                        <div class="sermon-actions">
                            <a href="${s.video_url || '#'}" target="_blank" class="btn"><i class="fas fa-play"></i> Assistir</a>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function renderContact(data) {
            const el = document.getElementById('contactInfo');
            if (!el) return;
            
            el.innerHTML = `
                <h3>Informações de Contato</h3>
                <p><i class="fas fa-map-marker-alt"></i> ${data.address}</p>
                <p><i class="fas fa-phone"></i> ${data.phone}</p>
                <p><i class="fas fa-envelope"></i> ${data.email}</p>
                
                <h3>Horários de Culto</h3>
                <div>${(data.serviceTimes || '').replace(/\n/g, '<br>')}</div>
            `;
        }

        /***********************
         * Gerenciamento de Emails
         ***********************/
        async function renderEmails() {
            if (!isAdmin()) return;

            try {
                const data = await loadData();
                const emails = data.emails || [];
                const searchTerm = document.getElementById('searchEmail').value.toLowerCase();
                const filterCategory = document.getElementById('filterCategory').value;
                
                // Filtrar emails
                let filteredEmails = emails;
                if (searchTerm) {
                    filteredEmails = filteredEmails.filter(email => 
                        email.name.toLowerCase().includes(searchTerm) || 
                        email.email.toLowerCase().includes(searchTerm)
                    );
                }
                if (filterCategory) {
                    filteredEmails = filteredEmails.filter(email => email.category === filterCategory);
                }
                
                // Atualizar estatísticas
                document.getElementById('totalEmails').textContent = emails.length;
                document.getElementById('newThisWeek').textContent = emails.filter(email => isThisWeek(new Date(email.created_at))).length;
                document.getElementById('subscribed').textContent = emails.filter(email => email.subscribed).length;
                
                // Renderizar lista
                const emailsList = document.getElementById('emailsList');
                emailsList.innerHTML = '';
                
                if (filteredEmails.length === 0) {
                    emailsList.innerHTML = '<p class="muted" style="text-align:center; padding:20px;">Nenhum email encontrado</p>';
                    return;
                }
                
                filteredEmails.forEach(email => {
                    const emailItem = document.createElement('div');
                    emailItem.className = 'email-item';
                    emailItem.innerHTML = `
                        <div class="email-info">
                            <div class="email-name">${email.name}</div>
                            <div class="email-address">${email.email}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span class="email-category">${getCategoryLabel(email.category)}</span>
                            <div class="email-actions">
                                <button class="btn btn-outline" onclick="editEmail(${email.id})" style="padding:4px 8px; font-size:0.8rem;">Editar</button>
                                <button class="btn btn-outline" onclick="deleteEmailFromUI(${email.id})" style="padding:4px 8px; font-size:0.8rem; background:#e53e3e; color:white;">Excluir</button>
                            </div>
                        </div>
                    `;
                    emailsList.appendChild(emailItem);
                });
            } catch (error) {
                console.error('Erro ao renderizar emails:', error);
            }
        }

        function getCategoryLabel(category) {
            const labels = {
                'membro': 'Membro',
                'visitante': 'Visitante',
                'voluntario': 'Voluntário',
                'doador': 'Doador'
            };
            return labels[category] || category;
        }

        function isThisWeek(date) {
            const today = new Date();
            const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
            const endOfWeek = new Date(today.setDate(today.getDate() + 6));
            return date >= startOfWeek && date <= endOfWeek;
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        async function addManualEmail() {
            const name = document.getElementById('newEmailName').value.trim();
            const email = document.getElementById('newEmailAddress').value.trim();
            const category = document.getElementById('newEmailCategory').value;
            
            if (!name || !email) {
                alert('Por favor, preencha nome e email.');
                return;
            }
            
            if (!validateEmail(email)) {
                alert('Por favor, insira um email válido.');
                return;
            }
            
            try {
                const emailData = {
                    name: name,
                    email: email,
                    category: category,
                    subscribed: true
                };
                
                await saveEmail(emailData);
                
                // Limpar campos
                document.getElementById('newEmailName').value = '';
                document.getElementById('newEmailAddress').value = '';
                
                await renderEmails();
                alert('Email adicionado com sucesso!');
            } catch (error) {
                console.error('Erro ao adicionar email:', error);
                if (error.message.includes('duplicate')) {
                    alert('Este email já está cadastrado.');
                } else {
                    alert('Erro ao adicionar email.');
                }
            }
        }

        async function deleteEmailFromUI(id) {
            if (!confirm('Tem certeza que deseja excluir este email?')) return;
            
            try {
                await deleteEmail(id);
                await renderEmails();
                alert('Email excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir email:', error);
                alert('Erro ao excluir email.');
            }
        }

        function editEmail(id) {
            // Implementação básica - você pode expandir isso
            const newName = prompt('Editar nome:');
            if (newName) {
                alert('Funcionalidade de edição será implementada em breve');
            }
        }

        function exportEmails() {
            alert('Funcionalidade de exportação em desenvolvimento');
        }

        /***********************
         * Admin Panel Functions
         ***********************/
        function buildMinistryAdminRow(min) {
            const wrap = document.createElement('div');
            wrap.className = 'item-row';
            wrap.setAttribute('data-id', min.id || '');
            wrap.innerHTML = `
                <input type="text" data-field="name" value="${min.name || ''}" placeholder="Nome do ministério">
                <input type="text" data-field="description" value="${min.description || ''}" placeholder="Descrição">
                <input type="text" data-field="icon" value="${min.icon || ''}" placeholder="Ícone (FontAwesome)">
                <button class="btn btn-outline btn-remove">Remover</button>
            `;
            wrap.querySelector('.btn-remove').addEventListener('click', () => wrap.remove());
            return wrap;
        }

        function buildEventAdminRow(ev) {
            const wrap = document.createElement('div');
            wrap.className = 'item-row';
            wrap.setAttribute('data-id', ev.id || '');
            wrap.innerHTML = `
                <input type="text" data-field="day" value="${ev.day || ''}" placeholder="Dia">
                <input type="text" data-field="month" value="${ev.month || ''}" placeholder="Mês">
                <input type="text" data-field="title" value="${ev.title || ''}" placeholder="Título">
                <input type="text" data-field="time" value="${ev.time || ''}" placeholder="Horário">
                <input type="text" data-field="location" value="${ev.location || ''}" placeholder="Local">
                <button class="btn btn-outline btn-remove">Remover</button>
            `;
            wrap.querySelector('.btn-remove').addEventListener('click', () => wrap.remove());
            return wrap;
        }

        function buildSermonAdminRow(s) {
            const wrap = document.createElement('div');
            wrap.className = 'item-row';
            wrap.setAttribute('data-id', s.id || '');
            wrap.innerHTML = `
                <input type="text" data-field="title" value="${s.title || ''}" placeholder="Título">
                <input type="text" data-field="pastor" value="${s.pastor || ''}" placeholder="Pastor">
                <input type="text" data-field="date" value="${s.date || ''}" placeholder="Data">
                <input type="text" data-field="img_url" value="${s.img_url || ''}" placeholder="URL da imagem">
                <input type="text" data-field="video_url" value="${s.video_url || ''}" placeholder="URL do vídeo">
                <input type="text" data-field="description" value="${s.description || ''}" placeholder="Descrição">
                <button class="btn btn-outline btn-remove">Remover</button>
            `;
            wrap.querySelector('.btn-remove').addEventListener('click', () => wrap.remove());
            return wrap;
        }

        async function populateAdminFields() {
            try {
                const data = await loadData();
                
                // Conteúdo textual
                document.getElementById('adminHeroTitle').value = data.heroTitle || '';
                document.getElementById('adminAddress').value = data.address || '';
                document.getElementById('adminAboutTitle').value = data.aboutTitle || '';
                document.getElementById('adminAboutSubtitle').value = data.aboutSubtitle || '';
                document.getElementById('adminAboutText1').value = data.aboutText1 || '';
                document.getElementById('adminAboutText2').value = data.aboutText2 || '';
                document.getElementById('adminAboutText3').value = data.aboutText3 || '';
                document.getElementById('adminMinistriesTitle').value = data.ministriesTitle || '';
                document.getElementById('adminMinistriesSubtitle').value = data.ministriesSubtitle || '';
                document.getElementById('adminDonationTitle').value = data.donationTitle || '';
                document.getElementById('adminDonationSubtitle').value = data.donationSubtitle || '';
                document.getElementById('adminDonationText').value = data.donationText || '';
                document.getElementById('adminPixDescription').value = data.pixDescription || '';
                document.getElementById('adminPresentialDonationText').value = data.presentialDonationText || '';
                
                // Ministérios
                const adminMinistriesList = document.getElementById('adminMinistriesList');
                adminMinistriesList.innerHTML = '';
                data.ministries.forEach(min => adminMinistriesList.appendChild(buildMinistryAdminRow(min)));
                
                // Eventos
                const adminEventsList = document.getElementById('adminEventsList');
                adminEventsList.innerHTML = '';
                data.events.forEach(ev => adminEventsList.appendChild(buildEventAdminRow(ev)));
                
                // Pregações
                const adminSermonList = document.getElementById('adminSermonList');
                adminSermonList.innerHTML = '';
                data.sermons.forEach(s => adminSermonList.appendChild(buildSermonAdminRow(s)));
                
                // Configurações
                document.getElementById('adminContactAddress').value = data.address || '';
                document.getElementById('adminPhone').value = data.phone || '';
                document.getElementById('adminEmail').value = data.email || '';
                document.getElementById('adminPix').value = data.pix || '';
                document.getElementById('adminServiceTimes').value = data.serviceTimes || '';
                
                // Emails
                await renderEmails();
            } catch (error) {
                console.error('Erro ao popular campos admin:', error);
            }
        }

        async function collectAdminFieldsAndSave() {
            try {
                // Salvar configurações textuais
                const textFields = {
                    'heroTitle': document.getElementById('adminHeroTitle').value,
                    'address': document.getElementById('adminAddress').value,
                    'aboutTitle': document.getElementById('adminAboutTitle').value,
                    'aboutSubtitle': document.getElementById('adminAboutSubtitle').value,
                    'aboutText1': document.getElementById('adminAboutText1').value,
                    'aboutText2': document.getElementById('adminAboutText2').value,
                    'aboutText3': document.getElementById('adminAboutText3').value,
                    'ministriesTitle': document.getElementById('adminMinistriesTitle').value,
                    'ministriesSubtitle': document.getElementById('adminMinistriesSubtitle').value,
                    'donationTitle': document.getElementById('adminDonationTitle').value,
                    'donationSubtitle': document.getElementById('adminDonationSubtitle').value,
                    'donationText': document.getElementById('adminDonationText').value,
                    'pixDescription': document.getElementById('adminPixDescription').value,
                    'presentialDonationText': document.getElementById('adminPresentialDonationText').value,
                    'serviceTimes': document.getElementById('adminServiceTimes').value,
                    'phone': document.getElementById('adminPhone').value,
                    'email': document.getElementById('adminEmail').value,
                    'pix': document.getElementById('adminPix').value
                };

                // Salvar cada configuração
                for (const [key, value] of Object.entries(textFields)) {
                    if (value !== null && value !== undefined) {
                        await saveConfig(key, value);
                    }
                }

                // Salvar ministérios, eventos e pregações
                await saveAllMinistries();
                await saveAllEvents();
                await saveAllSermons();

                alert('Alterações salvas com sucesso!');
                renderAll();
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                alert('Erro ao salvar alterações.');
            }
        }

        async function saveAllMinistries() {
            const ministryNodes = Array.from(document.getElementById('adminMinistriesList').querySelectorAll('.item-row'));
            
            for (const node of ministryNodes) {
                const ministry = {
                    name: node.querySelector('[data-field="name"]').value,
                    description: node.querySelector('[data-field="description"]').value,
                    icon: node.querySelector('[data-field="icon"]').value
                };
                
                const existingId = node.getAttribute('data-id');
                if (existingId) {
                    ministry.id = parseInt(existingId);
                }
                
                await saveMinistry(ministry);
            }
        }

        async function saveAllEvents() {
            const eventNodes = Array.from(document.getElementById('adminEventsList').querySelectorAll('.item-row'));
            
            for (const node of eventNodes) {
                const event = {
                    day: node.querySelector('[data-field="day"]').value,
                    month: node.querySelector('[data-field="month"]').value,
                    title: node.querySelector('[data-field="title"]').value,
                    time: node.querySelector('[data-field="time"]').value,
                    location: node.querySelector('[data-field="location"]').value
                };
                
                const existingId = node.getAttribute('data-id');
                if (existingId) {
                    event.id = parseInt(existingId);
                }
                
                await saveEvent(event);
            }
        }

        async function saveAllSermons() {
            const sermonNodes = Array.from(document.getElementById('adminSermonList').querySelectorAll('.item-row'));
            
            for (const node of sermonNodes) {
                const sermon = {
                    title: node.querySelector('[data-field="title"]').value,
                    pastor: node.querySelector('[data-field="pastor"]').value,
                    date: node.querySelector('[data-field="date"]').value,
                    img_url: node.querySelector('[data-field="img_url"]').value,
                    video_url: node.querySelector('[data-field="video_url"]').value,
                    description: node.querySelector('[data-field="description"]').value
                };
                
                const existingId = node.getAttribute('data-id');
                if (existingId) {
                    sermon.id = parseInt(existingId);
                }
                
                await saveSermon(sermon);
            }
        }

        function openAdminPanel() {
            document.getElementById('adminPanel').classList.add('show');
            document.getElementById('logoutBtn').style.display = 'inline-block';
            populateAdminFields();
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.remove('show');
        }

        function resetToDefault() {
            if (!confirm('Restaurar os dados padrões? Essa ação irá recriar os dados iniciais.')) return;
            // Implementação simplificada - você pode expandir isso
            alert('Funcionalidade de reset em desenvolvimento');
        }

        /***********************
         * Event Listeners
         ***********************/
        document.addEventListener('DOMContentLoaded', function() {
            // Renderizar dados ao carregar
            renderAll();

            // mobile menu
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const nav = document.querySelector('nav');
            if (mobileMenuBtn && nav) {
                mobileMenuBtn.addEventListener('click', () => nav.classList.toggle('active'));
                document.querySelectorAll('nav a').forEach(link => link.addEventListener('click', () => nav.classList.remove('active')));
            }

            // smooth scroll
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    if (targetId === '#') return;
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        window.scrollTo({ top: targetElement.offsetTop - 80, behavior: 'smooth' });
                    }
                });
            });

            // contact form behavior
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                contactForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const name = document.getElementById('contact_name').value.trim();
                    const email = document.getElementById('contact_email').value.trim();
                    const message = document.getElementById('contact_message').value.trim();
                    
                    if (name && email && message) {
                        try {
                            await saveEmail({
                                name: name,
                                email: email,
                                category: 'visitante',
                                subscribed: true
                            });
                            
                            alert('Mensagem enviada com sucesso! Entraremos em contato em breve.');
                            contactForm.reset();
                        } catch (error) {
                            console.error('Erro ao salvar email:', error);
                            alert('Erro ao enviar mensagem. Tente novamente.');
                        }
                    } else {
                        alert('Por favor, preencha todos os campos.');
                    }
                });
            }

            // PIX copy
            window.copyPixKey = function() {
                const pixKey = document.getElementById('pixKey').textContent;
                navigator.clipboard.writeText(pixKey).then(() => {
                    alert('Chave PIX copiada para a área de transferência!');
                });
            };

            // Admin modal open
            const openAdminBtn = document.getElementById('openAdminBtn');
            const loginModal = document.getElementById('loginModal');
            const submitLogin = document.getElementById('submitLogin');
            const cancelLogin = document.getElementById('cancelLogin');
            const adminPanel = document.getElementById('adminPanel');
            const logoutBtn = document.getElementById('logoutBtn');
            const closeAdminPanel = document.getElementById('closeAdminPanel');

            if (openAdminBtn) {
                openAdminBtn.addEventListener('click', () => {
                    if (isAdmin()) {
                        openAdminPanel();
                        return;
                    }
                    loginModal.classList.add('show');
                    loginModal.setAttribute('aria-hidden', 'false');
                });
            }

            if (cancelLogin) {
                cancelLogin.addEventListener('click', () => {
                    loginModal.classList.remove('show');
                    loginModal.setAttribute('aria-hidden', 'true');
                });
            }

            if (submitLogin) {
                submitLogin.addEventListener('click', () => {
                    const email = document.getElementById('adminEmailInput').value.trim();
                    const pass = document.getElementById('adminPass').value.trim();
                    
                    // Credenciais simples para demonstração
                    if (email === 'admin@igreja.com' && pass === '123456') {
                        setAdmin(true);
                        loginModal.classList.remove('show');
                        loginModal.setAttribute('aria-hidden', 'true');
                        openAdminPanel();
                        alert('Login bem-sucedido. Seja bem-vindo(a), administrador(a).');
                        document.getElementById('adminEmailInput').value = '';
                        document.getElementById('adminPass').value = '';
                    } else {
                        alert('Credenciais inválidas. Use: admin@igreja.com / 123456');
                    }
                });
            }

            if (closeAdminPanel) {
                closeAdminPanel.addEventListener('click', closeAdminPanel);
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    setAdmin(false);
                    document.getElementById('logoutBtn').style.display = 'none';
                    closeAdminPanel();
                    alert('Você saiu da conta administrativa.');
                });
            }

            // botões de adicionar item
            const addMinistryBtn = document.getElementById('addMinistryBtn');
            if (addMinistryBtn) {
                addMinistryBtn.addEventListener('click', () => {
                    const container = document.getElementById('adminMinistriesList');
                    container.appendChild(buildMinistryAdminRow({ name: '', description: '', icon: 'fas fa-hands-helping' }));
                });
            }
            
            const addEventBtn = document.getElementById('addEventBtn');
            if (addEventBtn) {
                addEventBtn.addEventListener('click', () => {
                    const container = document.getElementById('adminEventsList');
                    container.appendChild(buildEventAdminRow({ day: '', month: '', title: '', time: '', location: '' }));
                });
            }
            
            const addSermonBtn = document.getElementById('addSermonBtn');
            if (addSermonBtn) {
                addSermonBtn.addEventListener('click', () => {
                    const container = document.getElementById('adminSermonList');
                    container.appendChild(buildSermonAdminRow({ title: '', pastor: '', date: '', img_url: '', video_url: '', description: '' }));
                });
            }

            // salvar alterações
            const saveAllBtn = document.getElementById('saveAllBtn');
            if (saveAllBtn) {
                saveAllBtn.addEventListener('click', collectAdminFieldsAndSave);
            }

            // restaurar
            const resetDataBtn = document.getElementById('resetDataBtn');
            if (resetDataBtn) {
                resetDataBtn.addEventListener('click', resetToDefault);
            }

            // quando abrir o painel, mostrar botão logout
            if (isAdmin()) {
                document.getElementById('logoutBtn').style.display = 'inline-block';
            }

            // quando fechar modal clicando fora
            if (loginModal) {
                loginModal.addEventListener('click', (e) => {
                    if (e.target === loginModal) {
                        loginModal.classList.remove('show');
                        loginModal.setAttribute('aria-hidden', 'true');
                    }
                });
            }

            // Navegação entre abas do admin
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active de todas as abas
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Adiciona active à aba clicada
                    this.classList.add('active');
                    
                    // Mostra o conteúdo correspondente
                    const tabId = this.getAttribute('data-tab');
                    const contentId = `admin${tabId.charAt(0).toUpperCase() + tabId.slice(1)}Tab`;
                    const contentElement = document.getElementById(contentId);
                    if (contentElement) {
                        contentElement.classList.add('active');
                    }
                    
                    // Se for a aba de emails, renderizar emails
                    if (tabId === 'emails') {
                        renderEmails();
                    }
                });
            });

            // Eventos para busca e filtro de emails
            const searchEmail = document.getElementById('searchEmail');
            const filterCategory = document.getElementById('filterCategory');
            
            if (searchEmail) {
                searchEmail.addEventListener('input', renderEmails);
            }
            if (filterCategory) {
                filterCategory.addEventListener('change', renderEmails);
            }

            // Expor funções globais
            window.addManualEmail = addManualEmail;
            window.deleteEmailFromUI = deleteEmailFromUI;
            window.editEmail = editEmail;
            window.exportEmails = exportEmails;
        });

        // Teste inicial
        console.log('Sistema Igreja carregado com Supabase');
    </script>
</body>
</html>